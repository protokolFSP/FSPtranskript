name: Transcribe IA batch (parallel)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Bu run'da kaç dosya işlensin (örn 4/10/20)"
        required: true
        default: "4"
        type: string
      max_parallel:
        description: "Aynı anda kaç job koşsun (örn 4/6/8)"
        required: true
        default: "6"
        type: string
      match:
        description: "Opsiyonel filtre (substring). Boş=hepsi"
        required: false
        default: ""
        type: string

  schedule:
    - cron: "0 * * * *" # her saat başı

permissions:
  contents: write

concurrency:
  group: ia-transcribe
  cancel-in-progress: false

env:
  IA_IDENTIFIER: vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.pick.outputs.matrix }}
      count: ${{ steps.pick.outputs.count }}
      max_parallel: ${{ steps.pick.outputs.max_parallel }}
    steps:
      - uses: actions/checkout@v4

      - name: Upload transcribe tool (avoid checkout in matrix jobs)
        uses: actions/upload-artifact@v4
        with:
          name: tooling
          path: tools/transcribe_ia_whisper.py

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps for listing
        run: |
          python -m pip install -U pip
          pip install requests tqdm

      - id: pick
        name: Pick next missing files
        env:
          # schedule: repo variables (TRANSCRIBE_BATCH_SIZE / TRANSCRIBE_MAX_PARALLEL / TRANSCRIBE_MATCH)
          # manual: workflow inputs
          BATCH_SIZE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.batch_size || vars.TRANSCRIBE_BATCH_SIZE || '20' }}
          MAX_PARALLEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.max_parallel || vars.TRANSCRIBE_MAX_PARALLEL || '6' }}
          MATCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.match || vars.TRANSCRIBE_MATCH || '' }}
        run: |
          python - <<'PY'
          import json, os, subprocess, sys

          identifier = os.environ["IA_IDENTIFIER"]
          batch_size = int(os.environ["BATCH_SIZE"])
          max_parallel = int(os.environ["MAX_PARALLEL"])
          match = os.environ.get("MATCH", "").strip()

          cmd = [
              sys.executable, "tools/transcribe_ia_whisper.py",
              "--identifier", identifier,
              "--out-dir", "transcripts",
              "--list-missing-json",
          ]
          if match:
              cmd += ["--match", match]

          missing = json.loads(subprocess.check_output(cmd).decode("utf-8"))
          picked = missing[:batch_size]

          matrix = [{"idx": i, "file": f} for i, f in enumerate(picked)]
          out = json.dumps(matrix, ensure_ascii=False)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"matrix={out}\n")
              f.write(f"count={len(matrix)}\n")
              f.write(f"max_parallel={max_parallel}\n")

          print("Picked:", matrix)
          print("Batch size:", batch_size, "| Max parallel:", max_parallel)
          PY

  transcribe:
    needs: prepare
    if: ${{ needs.prepare.outputs.count != '0' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJson(needs.prepare.outputs.max_parallel) }}
      matrix:
        item: ${{ fromJson(needs.prepare.outputs.matrix) }}
    timeout-minutes: 360
    steps:
      - name: Download tool (no checkout)
        uses: actions/download-artifact@v4
        with:
          name: tooling
          path: tooling

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache model downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/huggingface
            ~/.cache/whisper
          key: whisper-cache-${{ runner.os }}-small-v1
          restore-keys: |
            whisper-cache-${{ runner.os }}-

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install faster-whisper requests tqdm

      - name: Transcribe one file
        env:
          FILE: ${{ matrix.item.file }}
        run: |
          python tooling/transcribe_ia_whisper.py \
            --identifier "$IA_IDENTIFIER" \
            --out-dir "transcripts" \
            --file "$FILE" \
            --model "small" \
            --language "de" \
            --device "cpu" \
            --compute-type "int8" \
            --beam-size 1 \
            --vad-filter

          python - <<'PY'
          import os, shutil
          from pathlib import Path

          fn = os.environ["FILE"]
          base = Path(fn).name
          base = Path(base).with_suffix("").name

          out = Path("artifact_out")
          out.mkdir(parents=True, exist_ok=True)

          for ext in (".txt", ".srt"):
              src = Path("transcripts") / f"{base}{ext}"
              if src.exists():
                  shutil.copy2(src, out / src.name)
          PY

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: transcripts-${{ matrix.item.idx }}
          path: artifact_out/*

  merge_and_push:
    needs: [prepare, transcribe]
    if: ${{ needs.prepare.outputs.count != '0' && always() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all transcript artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge into transcripts/
        run: |
          mkdir -p transcripts
          find artifacts -type f \( -name "*.txt" -o -name "*.srt" \) -print -exec cp -f {} transcripts/ \;

      - name: Commit & push once
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add transcripts
          git commit -m "Add batch transcripts (Whisper small, DE)" || exit 0
          git pull --rebase
          git push
